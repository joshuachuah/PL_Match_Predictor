<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Primary Meta Tags -->
    <title>PremierProphet - AI-Powered Premier League Predictions | FPL Analytics</title>
    <meta name="title" content="PremierProphet - AI-Powered Premier League Predictions">
    <meta name="description" content="Get accurate Premier League match predictions powered by machine learning and real-time FPL data. Predict scores, outcomes, and probabilities for upcoming fixtures with our advanced AI model.">
    <meta name="keywords" content="PremierProphet, Premier League predictions, football match predictor, FPL analytics, soccer predictions, machine learning football, Premier League fixtures, football AI, match outcome predictor, EPL predictions, football analytics">
    <meta name="author" content="PremierProphet">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://premierprophet.dev">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://premierprophet.dev">
    <meta property="og:title" content="PremierProphet - AI-Powered Premier League Predictions">
    <meta property="og:description" content="Get accurate Premier League match predictions powered by machine learning and real-time FPL data. Predict scores, outcomes, and probabilities for upcoming fixtures.">
    <meta property="og:image" content="https://premierprophet.dev/static/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="PremierProphet">
    <meta property="og:locale" content="en_US">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://premierprophet.dev">
    <meta property="twitter:title" content="PremierProphet - AI-Powered Premier League Predictions">
    <meta property="twitter:description" content="Get accurate Premier League match predictions powered by machine learning and real-time FPL data.">
    <meta property="twitter:image" content="https://premierprophet.dev/static/twitter-image.png">

    <!-- Additional SEO Meta Tags -->
    <meta name="theme-color" content="#37003c">
    <meta name="msapplication-TileColor" content="#37003c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="PL Predictor">
    
    <!-- Performance and Loading -->
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="prefetch" href="/api/status">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='site.webmanifest') }}">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "PremierProphet",
        "url": "https://premierprophet.dev",
        "description": "AI-powered Premier League match prediction tool using real-time FPL data and machine learning algorithms",
        "applicationCategory": "SportsApplication",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "creator": {
            "@type": "Organization",
            "name": "PremierProphet",
            "url": "https://premierprophet.dev"
        },
        "mainEntity": {
            "@type": "SportsEvent",
            "@id": "https://premierprophet.dev/#premier-league-predictions",
            "name": "Premier League Match Predictions",
            "sport": "Soccer",
            "description": "Real-time predictions for Premier League football matches using machine learning"
        },
        "keywords": ["Premier League", "Football Predictions", "Machine Learning", "FPL", "Soccer Analytics"],
        "audience": {
            "@type": "Audience",
            "audienceType": "Football Fans, Fantasy Premier League Players, Sports Bettors"
        }
    }
    </script>
</head>
<body>
    
    <div class="container">
        <header class="header" role="banner">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-futbol" aria-hidden="true"></i>
                    <h1>PremierProphet</h1>
                </div>
                <p class="subtitle">AI-powered Premier League predictions using live FPL data and machine learning</p>
            </div>
        </header>

        <main role="main" id="main-content" class="main-content">
            <!-- Status section hidden for cleaner interface -->
            <section class="status-section" aria-labelledby="status-heading" style="display: none;">
                <article class="card">
                    <header class="card-header">
                        <h2 id="status-heading"><i class="fas fa-chart-line" aria-hidden="true"></i> System Status</h2>
                    </header>
                    <div class="card-content">
                        <dl id="status-content">
                            <div class="status-item">
                                <dt class="status-label">Model Status:</dt>
                                <dd id="model-status" class="status-badge status-pending">Not Initialized</dd>
                            </div>
                            <div class="status-item">
                                <dt class="status-label">Current Gameweek:</dt>
                                <dd id="current-gw" class="status-value">-</dd>
                            </div>
                            <div class="status-item">
                                <dt class="status-label">Next Gameweek:</dt>
                                <dd id="next-gw" class="status-value">-</dd>
                            </div>
                        </dl>
                        <div id="status-message" class="status-message" role="status" aria-live="polite"></div>
                    </div>
                </article>
            </section>

            <!-- Control buttons hidden for cleaner interface -->
            <section class="control-section" aria-labelledby="control-heading" style="display: none;">
                <article class="card">
                    <div class="card-content">
                        <h2 id="control-heading" class="sr-only">Prediction Controls</h2>
                        <div class="control-buttons" role="group" aria-label="Prediction control buttons">
                            <button id="init-btn" class="btn btn-primary" type="button" aria-describedby="init-description">
                                <i class="fas fa-play" aria-hidden="true"></i>
                                Initialize Predictor
                            </button>
                            <span id="init-description" class="sr-only">Initialize the AI model with current Premier League data</span>
                            
                            <button id="predict-btn" class="btn btn-secondary" type="button" disabled aria-describedby="predict-description">
                                <i class="fas fa-crystal-ball" aria-hidden="true"></i>
                                Get Predictions
                            </button>
                            <span id="predict-description" class="sr-only">Generate match predictions for the next gameweek</span>
                        </div>
                    </div>
                </article>
            </section>

            <section id="loading-section" class="loading-section" style="display: none;" aria-labelledby="loading-heading">
                <article class="card loading-card">
                    <div class="card-content">
                        <h2 id="loading-heading" class="sr-only">Loading Status</h2>
                        <div class="loading-spinner" role="status" aria-live="polite">
                            <div class="spinner" aria-hidden="true"></div>
                            <p id="loading-text">Loading predictions...</p>
                        </div>
                    </div>
                </article>
            </section>

            <section id="predictions-section" class="predictions-section" style="display: none;" aria-labelledby="predictions-heading">
                <article class="card">
                    <header class="card-header">
                        <h2 id="predictions-heading"><i class="fas fa-calendar-alt" aria-hidden="true"></i> <span id="predictions-title">Match Predictions</span></h2>
                    </header>
                    <div class="card-content">
                        <div id="predictions-content" class="predictions-content" role="region" aria-live="polite" aria-label="Match prediction results"></div>
                    </div>
                </article>
            </section>
        </main>

        <footer class="footer" role="contentinfo">
            <address>
                <p>Utilized Fantasy Premier League API</a> | Built with ❤️ for football fans</p>
            </address>
        </footer>
    </div>

    <script>
        let statusInterval;
        let isInitialized = false;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkStatus();
            startStatusPolling();
            // Auto-initialize and get predictions
            autoInitializeAndPredict();
        });

        // Button event listeners
        document.getElementById('init-btn').addEventListener('click', initializePredictor);
        document.getElementById('predict-btn').addEventListener('click', getPredictions);

        function startStatusPolling() {
            statusInterval = setInterval(checkStatus, 2000);
        }

        function stopStatusPolling() {
            if (statusInterval) {
                clearInterval(statusInterval);
            }
        }

        async function checkStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                updateStatusDisplay(data);
                
                if (data.model_ready && !isInitialized) {
                    isInitialized = true;
                    document.getElementById('predict-btn').disabled = false;
                    document.getElementById('init-btn').innerHTML = '<i class="fas fa-check"></i> Ready';
                    document.getElementById('init-btn').disabled = true;
                    hideLoading();
                    
                    // Automatically get predictions when model is ready
                    setTimeout(() => {
                        getPredictions();
                    }, 500);
                    
                    // Track model initialization for analytics
                    if (typeof trackModelInitialization === 'function') {
                        trackModelInitialization();
                    }
                }
            } catch (error) {
                console.error('Error checking status:', error);
            }
        }

        function updateStatusDisplay(data) {
            const modelStatus = document.getElementById('model-status');
            const statusMessage = document.getElementById('status-message');
            
            if (data.model_ready) {
                modelStatus.textContent = 'Ready';
                modelStatus.className = 'status-badge status-success';
                statusMessage.textContent = 'Model is ready for predictions!';
                statusMessage.className = 'status-message status-success';
            } else if (data.training_status.status === 'error') {
                modelStatus.textContent = 'Error';
                modelStatus.className = 'status-badge status-error';
                statusMessage.textContent = data.training_status.message;
                statusMessage.className = 'status-message status-error';
            } else if (data.training_status.status === 'initializing') {
                modelStatus.textContent = 'Initializing...';
                modelStatus.className = 'status-badge status-warning';
                statusMessage.textContent = data.training_status.message;
                statusMessage.className = 'status-message status-warning';
            } else {
                modelStatus.textContent = 'Not Initialized';
                modelStatus.className = 'status-badge status-pending';
                statusMessage.textContent = '';
            }
            
            document.getElementById('current-gw').textContent = data.current_gameweek || '-';
            document.getElementById('next-gw').textContent = data.next_gameweek || '-';
        }

        async function initializePredictor() {
            showLoading('Initializing predictor and training model...');
            document.getElementById('init-btn').disabled = true;
            
            try {
                const response = await fetch('/api/initialize', { method: 'POST' });
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to initialize');
                }
            } catch (error) {
                console.error('Error initializing:', error);
                hideLoading();
                alert('Error initializing predictor: ' + error.message);
                document.getElementById('init-btn').disabled = false;
            }
        }

        async function getPredictions() {
            showLoading('Fetching match predictions...');
            hidePredictions();
            
            try {
                const response = await fetch('/api/predict');
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to get predictions');
                }
                
                displayPredictions(data);
                hideLoading();
            } catch (error) {
                console.error('Error getting predictions:', error);
                hideLoading();
                alert('Error getting predictions: ' + error.message);
            }
        }

        function displayPredictions(data) {
            const content = document.getElementById('predictions-content');
            const title = document.getElementById('predictions-title');
            
            title.textContent = `Gameweek ${data.next_gameweek} Predictions`;
            
            if (!data.predictions || data.predictions.length === 0) {
                content.innerHTML = '<p class="no-matches">No upcoming matches found.</p>';
            } else {
                content.innerHTML = data.predictions.map(match => createMatchCard(match)).join('');
                
                // add structured data for predictions
                addPredictionStructuredData(data);
                
                // track prediction generation for analytics
                if (typeof trackPredictionEvent === 'function') {
                    trackPredictionEvent(data.next_gameweek, data.predictions.length);
                }
            }
            
            showPredictions();
        }

        function addPredictionStructuredData(data) {
            // Remove existing prediction structured data
            const existingScript = document.getElementById('prediction-structured-data');
            if (existingScript) {
                existingScript.remove();
            }

            // Create structured data for the predictions
            const structuredData = {
                "@context": "https://schema.org",
                "@type": "SportsEvent",
                "name": `Premier League Gameweek ${data.next_gameweek} Predictions`,
                "description": `AI-powered match predictions for Premier League Gameweek ${data.next_gameweek}`,
                "startDate": data.predictions[0]?.kickoff_time,
                "sport": "Soccer",
                "location": {
                    "@type": "Place",
                    "name": "Various Premier League Stadiums",
                    "address": {
                        "@type": "PostalAddress",
                        "addressCountry": "GB"
                    }
                },
                "organizer": {
                    "@type": "SportsOrganization",
                    "name": "Premier League",
                    "url": "https://www.premierleague.com"
                },
                "subEvent": data.predictions.map(match => ({
                    "@type": "SportsEvent",
                    "name": `${match.home_team} vs ${match.away_team}`,
                    "startDate": match.kickoff_time,
                    "competitor": [
                        {
                            "@type": "SportsTeam",
                            "name": match.home_team
                        },
                        {
                            "@type": "SportsTeam", 
                            "name": match.away_team
                        }
                    ],
                    "description": `Predicted outcome: ${match.prediction}. Confidence: ${Math.round(match.confidence * 100)}%`
                }))
            };

            // add structured data to page
            const script = document.createElement('script');
            script.type = 'application/ld+json';
            script.id = 'prediction-structured-data';
            script.textContent = JSON.stringify(structuredData);
            document.head.appendChild(script);
        }

        function createMatchCard(match) {
            const kickoffDate = new Date(match.kickoff_time);
            const formattedDate = kickoffDate.toLocaleDateString('en-GB', {
                weekday: 'short',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const confidence = Math.round(match.confidence * 100);
            const confidenceClass = confidence >= 70 ? 'high' : confidence >= 50 ? 'medium' : 'low';

            let probsHtml = '';
            if (match.probabilities && Object.keys(match.probabilities).length > 0) {
                // draw always in the middle
                const outcomes = Object.entries(match.probabilities);
                const sortedOutcomes = outcomes.sort(([outcomeA], [outcomeB]) => {
                    
                    // defining order
                    const getOrder = (outcome) => {
                        if (outcome === match.home_team) return 0;
                        if (outcome === 'Draw') return 1;
                        if (outcome === match.away_team) return 2;
                        return 3; // fallback
                    };
                    
                    return getOrder(outcomeA) - getOrder(outcomeB);
                });
                
                probsHtml = sortedOutcomes
                    .map(([outcome, prob]) => {
                        const percentage = Math.round(prob * 100);
                        const isSelected = outcome === match.prediction;
                        return `
                            <div class="probability-bar ${isSelected ? 'selected' : ''}">
                                <span class="outcome">${outcome}</span>
                                <div class="bar-container">
                                    <div class="bar" style="width: ${percentage}%"></div>
                                </div>
                                <span class="percentage">${percentage}%</span>
                            </div>
                        `;
                    }).join('');
            }

            return `
                <div class="match-card">
                    <div class="match-header">
                        <div class="teams">
                            <span class="home-team">${match.home_team}</span>
                            <span class="vs">vs</span>
                            <span class="away-team">${match.away_team}</span>
                        </div>
                        <div class="match-time">${formattedDate}</div>
                    </div>
                    <div class="prediction-result">
                        <div class="prediction-text">
                            <i class="fas fa-trophy"></i>
                            <strong>${match.prediction}</strong>
                        </div>
                    </div>
                    <div class="probabilities">
                        ${probsHtml}
                    </div>
                </div>
            `;
        }

        function showLoading(text = 'Loading...') {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-section').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading-section').style.display = 'none';
        }

        function showPredictions() {
            document.getElementById('predictions-section').style.display = 'block';
        }

        function hidePredictions() {
            document.getElementById('predictions-section').style.display = 'none';
        }

        async function autoInitializeAndPredict() {
            // Check if we need to initialize
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (!data.model_ready && !data.app_initialized) {
                    // Need to initialize
                    showLoading('Initializing predictor...');
                    await initializePredictor();
                } else if (data.model_ready) {
                    // Model is ready, get predictions immediately
                    await getPredictions();
                }
            } catch (error) {
                console.error('Error during auto-initialization:', error);
                showLoading('Unable to load predictions. Please check your connection.');
            }
        }
    </script>
</body>
</html>
