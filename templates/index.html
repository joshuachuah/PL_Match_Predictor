<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premier League Match Predictor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-futbol"></i>
                    <h1>Premier League Match Predictor</h1>
                </div>
                <p class="subtitle">AI-powered predictions using live FPL data</p>
            </div>
        </header>

        <!-- Status Section -->
        <section class="status-section">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-chart-line"></i> System Status</h2>
                </div>
                <div class="card-content">
                    <div id="status-content">
                        <div class="status-item">
                            <span class="status-label">Model Status:</span>
                            <span id="model-status" class="status-badge status-pending">Not Initialized</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Current Gameweek:</span>
                            <span id="current-gw" class="status-value">-</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Next Gameweek:</span>
                            <span id="next-gw" class="status-value">-</span>
                        </div>
                    </div>
                    <div id="status-message" class="status-message"></div>
                </div>
            </div>
        </section>

        <!-- Control Section -->
        <section class="control-section">
            <div class="card">
                <div class="card-content">
                    <div class="control-buttons">
                        <button id="init-btn" class="btn btn-primary">
                            <i class="fas fa-play"></i>
                            Initialize Predictor
                        </button>
                        <button id="predict-btn" class="btn btn-secondary" disabled>
                            <i class="fas fa-crystal-ball"></i>
                            Get Predictions
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Loading Section -->
        <section id="loading-section" class="loading-section" style="display: none;">
            <div class="card">
                <div class="card-content">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <p id="loading-text">Loading...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Predictions Section -->
        <section id="predictions-section" class="predictions-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-calendar-alt"></i> <span id="predictions-title">Match Predictions</span></h2>
                </div>
                <div class="card-content">
                    <div id="predictions-content" class="predictions-content"></div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <p>Powered by Fantasy Premier League API | Built with ❤️ for football fans</p>
        </footer>
    </div>

    <script>
        let statusInterval;
        let isInitialized = false;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkStatus();
            startStatusPolling();
        });

        // Button event listeners
        document.getElementById('init-btn').addEventListener('click', initializePredictor);
        document.getElementById('predict-btn').addEventListener('click', getPredictions);

        function startStatusPolling() {
            statusInterval = setInterval(checkStatus, 2000);
        }

        function stopStatusPolling() {
            if (statusInterval) {
                clearInterval(statusInterval);
            }
        }

        async function checkStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                updateStatusDisplay(data);
                
                if (data.model_ready && !isInitialized) {
                    isInitialized = true;
                    document.getElementById('predict-btn').disabled = false;
                    document.getElementById('init-btn').innerHTML = '<i class="fas fa-check"></i> Ready';
                    document.getElementById('init-btn').disabled = true;
                    hideLoading();
                }
            } catch (error) {
                console.error('Error checking status:', error);
            }
        }

        function updateStatusDisplay(data) {
            const modelStatus = document.getElementById('model-status');
            const statusMessage = document.getElementById('status-message');
            
            if (data.model_ready) {
                modelStatus.textContent = 'Ready';
                modelStatus.className = 'status-badge status-success';
                statusMessage.textContent = 'Model is ready for predictions!';
                statusMessage.className = 'status-message status-success';
            } else if (data.training_status.status === 'error') {
                modelStatus.textContent = 'Error';
                modelStatus.className = 'status-badge status-error';
                statusMessage.textContent = data.training_status.message;
                statusMessage.className = 'status-message status-error';
            } else if (data.training_status.status === 'initializing') {
                modelStatus.textContent = 'Initializing...';
                modelStatus.className = 'status-badge status-warning';
                statusMessage.textContent = data.training_status.message;
                statusMessage.className = 'status-message status-warning';
            } else {
                modelStatus.textContent = 'Not Initialized';
                modelStatus.className = 'status-badge status-pending';
                statusMessage.textContent = '';
            }
            
            document.getElementById('current-gw').textContent = data.current_gameweek || '-';
            document.getElementById('next-gw').textContent = data.next_gameweek || '-';
        }

        async function initializePredictor() {
            showLoading('Initializing predictor and training model...');
            document.getElementById('init-btn').disabled = true;
            
            try {
                const response = await fetch('/api/initialize', { method: 'POST' });
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to initialize');
                }
            } catch (error) {
                console.error('Error initializing:', error);
                hideLoading();
                alert('Error initializing predictor: ' + error.message);
                document.getElementById('init-btn').disabled = false;
            }
        }

        async function getPredictions() {
            showLoading('Fetching match predictions...');
            hidePredictions();
            
            try {
                const response = await fetch('/api/predict');
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to get predictions');
                }
                
                displayPredictions(data);
                hideLoading();
            } catch (error) {
                console.error('Error getting predictions:', error);
                hideLoading();
                alert('Error getting predictions: ' + error.message);
            }
        }

        function displayPredictions(data) {
            const content = document.getElementById('predictions-content');
            const title = document.getElementById('predictions-title');
            
            title.textContent = `Gameweek ${data.next_gameweek} Predictions`;
            
            if (!data.predictions || data.predictions.length === 0) {
                content.innerHTML = '<p class="no-matches">No upcoming matches found.</p>';
            } else {
                content.innerHTML = data.predictions.map(match => createMatchCard(match)).join('');
            }
            
            showPredictions();
        }

        function createMatchCard(match) {
            const kickoffDate = new Date(match.kickoff_time);
            const formattedDate = kickoffDate.toLocaleDateString('en-GB', {
                weekday: 'short',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const confidence = Math.round(match.confidence * 100);
            const confidenceClass = confidence >= 70 ? 'high' : confidence >= 50 ? 'medium' : 'low';

            let probsHtml = '';
            if (match.probabilities && Object.keys(match.probabilities).length > 0) {
                // Sort probabilities to ensure Draw is always in the middle
                const outcomes = Object.entries(match.probabilities);
                const sortedOutcomes = outcomes.sort(([outcomeA], [outcomeB]) => {
                    // Define the desired order: Home team (0), Draw (1), Away team (2)
                    const getOrder = (outcome) => {
                        if (outcome === match.home_team) return 0;
                        if (outcome === 'Draw') return 1;
                        if (outcome === match.away_team) return 2;
                        return 3; // fallback
                    };
                    
                    return getOrder(outcomeA) - getOrder(outcomeB);
                });
                
                probsHtml = sortedOutcomes
                    .map(([outcome, prob]) => {
                        const percentage = Math.round(prob * 100);
                        const isSelected = outcome === match.prediction;
                        return `
                            <div class="probability-bar ${isSelected ? 'selected' : ''}">
                                <span class="outcome">${outcome}</span>
                                <div class="bar-container">
                                    <div class="bar" style="width: ${percentage}%"></div>
                                </div>
                                <span class="percentage">${percentage}%</span>
                            </div>
                        `;
                    }).join('');
            }

            return `
                <div class="match-card">
                    <div class="match-header">
                        <div class="teams">
                            <span class="home-team">${match.home_team}</span>
                            <span class="vs">vs</span>
                            <span class="away-team">${match.away_team}</span>
                        </div>
                        <div class="match-time">${formattedDate}</div>
                    </div>
                    <div class="prediction-result">
                        <div class="prediction-text">
                            <i class="fas fa-trophy"></i>
                            <strong>${match.prediction}</strong>
                        </div>
                    </div>
                    <div class="probabilities">
                        ${probsHtml}
                    </div>
                </div>
            `;
        }

        function showLoading(text = 'Loading...') {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-section').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading-section').style.display = 'none';
        }

        function showPredictions() {
            document.getElementById('predictions-section').style.display = 'block';
        }

        function hidePredictions() {
            document.getElementById('predictions-section').style.display = 'none';
        }
    </script>
</body>
</html>
